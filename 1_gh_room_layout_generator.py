#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
住宅平面布局生成器 - 10x10版本
基于大语言模型(LLM)生成10x10住宅平面布局矩阵

该模块用于调用火山方舟API生成符合建筑规范的房间布局，
支持基于用户文字需求和预设边界掩码生成合理的住宅平面布局。
"""

# 导入操作系统相关库，用于处理环境变量和文件路径
import os
# 导入JSON库，用于数据序列化和反序列化
import json
# 导入火山方舟API客户端库，用于调用LLM服务
from volcenginesdkarkruntime import Ark

def generate_room_layout(system_prompt, user_requirement, api_key):
    """
    调用LLM API生成房间布局矩阵
    
    参数:
        system_prompt: 系统提示词，定义LLM的角色和任务要求
        user_requirement: 用户需求，包含具体的房间配置要求
        api_key: Ark API密钥，用于验证API访问权限
    
    返回:
        room_layout: 生成的10x10房间布局矩阵，或None（生成失败时）
    """
    try:
        # 初始化火山方舟API客户端
        client = Ark(
            base_url="https://ark.cn-beijing.volces.com/api/v3",  # API服务地址
            api_key=api_key,  # 身份验证密钥
        )
        
        # 打印调试信息，指示开始调用LLM API
        print("----- 调用LLM API生成10x10房间布局 -----")
        
        # 调用LLM API生成房间布局
        completion = client.chat.completions.create(
            model="deepseek-v3-1-terminus",  # 使用的LLM模型
            messages=[
                {"role": "system", "content": system_prompt},  # 系统提示词
                {"role": "user", "content": user_requirement},  # 用户需求
            ],
            response_format={"type": "json_object"},  # 指定输出格式为JSON对象
            thinking={"type": "enabled"},  # 启用思考模式，提高生成质量
        )
        
        # 解析LLM响应内容
        response_content = completion.choices[0].message.content
        # 将JSON字符串转换为Python对象（列表）
        room_layout = json.loads(response_content)
        
        # 返回生成的房间布局矩阵
        return room_layout
        
    except Exception as e:
        # 捕获并打印生成过程中的所有异常
        print(f"生成房间布局时发生错误: {str(e)}")
        return None

def main():
    """
    主函数：生成10x10房间布局并保存结果
    
    该函数执行以下步骤：
    1. 配置API密钥和输出文件路径
    2. 定义系统提示词和用户需求
    3. 调用LLM生成房间布局
    4. 保存生成结果到JSON文件
    5. 输出结果到控制台和Grasshopper端口
    """
    # --------------------------
    # 1. 配置参数
    # --------------------------
    
    # 从环境变量获取API密钥（推荐生产环境使用）
    api_key = os.environ.get('ARK_API_KEY')
    # 如果环境变量中没有API密钥，使用硬编码的测试密钥
    if not api_key:
        # 硬编码密钥，仅用于测试和开发环境
        api_key = "df09ff8e-4b81-4cd3-810e-3da8ed184829"
    
    # 输出文件路径配置：使用当前目录
    output_file = "FPGGen_RoomLayoutMatrix_10x10.json"
    
    # --------------------------
    # 2. 系统提示词定义
    # --------------------------
    # 定义LLM的系统角色和任务要求，包含详细的设计规范和约束
    system_prompt = """你是一个专业的住宅平面布局生成助手，能够基于用户的文字需求和预设边界掩码，智能生成符合建筑规范的初步可行性布局方案（非精确施工图）。核心设计原则：严格遵循硬性约束，软约束允许合理优化调整。

### 输入要求
用户需要提供以下信息：
1. **文字房间需求**：详细描述房间配置需求，例如"客厅需要宽敞，主卧带独立卫生间，需要两个卧室"等。
2. **边界约束**：系统已内置10×10边界掩码矩阵（0=外部不可建区域，1=可建区域），用户无需提供。该矩阵定义了建筑的可建设范围。
```json
[
[0,0,0,0,0,0,0,0,0,0],
[0,0,0,1,1,1,1,1,0,0],
[0,0,0,1,1,1,1,1,0,0],
[0,0,0,1,1,1,1,1,0,0],
[0,0,0,1,1,1,1,1,0,0],
[0,0,0,1,1,1,1,1,0,0],
[0,0,0,1,1,1,1,1,0,0],
[0,0,0,1,1,1,1,1,0,0],
[0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0]
]
```
注意：此矩阵为系统预设，生成时必须直接使用。

### 输出规范
生成一个10×10整数矩阵，仅使用0-13的整数编码，格式为标准JSON数组。具体要求：
- **完整性**：矩阵必须包含完整的10行，每行10个整数，无缺失值。
- **空间尺度**：每个网格单元代表2米×2米的实际空间尺寸，总设计范围为20米×20米的建筑区域。
- **编码体系**：严格按照以下规则进行房间类型编码：
  - `0`：外部空地（不可建设区域）
  - `1`：客厅（主要起居空间）
  - `2`：主卧（主卧室）
  - `3`：厨房（烹饪空间）
  - `4`：卫生间（卫浴空间）
  - `5`：餐厅（用餐空间）
  - `6`：儿童房（儿童卧室）
  - `7`：书房（工作学习空间）
  - `8`：次卧（次卧室）
  - `9`：客房（客人卧室）
  - `10`：阳台/庭院（户外延伸空间）
  - `11`：入口区域（玄关/门厅）
  - `12`：储藏室（储物收纳空间）
  - `13`：正门（入户门位置）

### 设计约束体系
#### 硬性约束（必须100%满足，不可妥协）
1. **边界兼容性**：边界掩码值为0的位置，输出矩阵必须严格为0；掩码值为1的位置，输出必须为1-13的有效房间编码。
2. **正门唯一性**：矩阵中必须且只能有一个`13`（正门），且该位置必须同时满足：
   - 四邻域（上、下、左、右）至少相邻一个`0`（外部区域）
   - 至少相邻一个`1-12`的内部功能区域
3. **入口缓冲区**：正门（`13`）周围必须形成至少2×2格的`11`（玄关/门厅）缓冲区域。空间受限时，应优先保证此缓冲要求。

#### 功能性约束（核心设计要求）
4. **空间连续性**：主要功能区域（除卫生间和次卧外）应保持空间连续性，形状尽量接近矩形，避免过于复杂或不规则的几何形态。
5. **交通组织**：客厅（`1`）应位于平面中心区域，承担交通节点功能，有效串联各功能房间。
6. **面积配比**：基于可建设区域总格数（35格），各功能区域面积应控制在合理范围内：
   - 主卧（`2`）：32-40平方米（8-10格）
   - 次卧（`8`）：16平方米×2间（每间4格）
   - 厨房（`3`）：12-16平方米（3-4格）
   - 卫生间（`4`）：12-16平方米（3-4格）
   - 餐厅（`5`）：16-24平方米（4-6格）

#### 舒适性约束（优化设计目标）
7. **采光优化**：
   - 客厅和卧室应优先布置在建筑南侧（矩阵下部，行索引较大区域）
   - 确保主要居住空间获得充足自然采光
8. **功能邻近**：厨房（`3`）与餐厅（`5`）的空间距离应尽量控制在3米（1.5格）以内，优化餐饮动线。
9. **通行空间**：走廊等通行区域宽度应≥2米（1格），确保舒适的通行体验。
10. **连通性保障**：主要功能房间（客厅、卧室、厨房、餐厅）必须通过相邻单元格实现有效连通，避免空间隔离。
11. **形态优化**：房间形状应避免过度狭长，建议长宽比控制在3:1以内，提升空间使用效率。
12. **入口可达性**：客厅（`1`）应尽量靠近正门（`13`），理想情况下，从正门出发经过≤4米（2格）路径（可穿越玄关`11`）即可进入客厅空间。

### 执行准则
#### 设计规范
- **原创性要求**：严禁复制示例内容，必须基于用户具体需求和预设边界矩阵进行动态生成
- **格式规范**：严格遵循标准JSON数组格式，确保缩进一致、逗号分隔正确
- **完整性保障**：必须输出完整的10×10矩阵，无缺失值或格式错误

#### 质量把控
- **约束优先级**：严格按照硬性约束→功能性约束→舒适性约束的层级执行
- **合理性验证**：生成方案应满足基本的建筑逻辑和空间使用效率
- **可读性优化**：布局应清晰合理，便于后续深化设计

### 输出格式模板（结构参考，内容需动态生成）
```json
[
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 1, 1, 1, 1, 1, 0, 0],
  [0, 0, 0, 1, 1, 1, 1, 1, 0, 0],
  [0, 0, 0, 1, 1, 1, 1, 1, 0, 0],
  [0, 0, 0, 1, 1, 1, 1, 1, 0, 0],
  [0, 0, 0, 1, 1, 1, 1, 1, 0, 0],
  [0, 0, 0, 1, 1, 1, 1, 1, 0, 0],
  [0, 0, 0, 1, 1, 1, 1, 1, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
]
// 每个数值代表2米×2米的实际空间单元，总设计范围为20米×20米
```
"""
    
    # --------------------------
    # 3. 用户需求定义
    # --------------------------
    
    # 基本住宅布局需求，可根据实际情况修改
    basic_requirement = """提供一个家庭住宅布局，客厅需要宽敞，主卧带独立卫生间，需要两个卧室，一个厨房，一个餐厅，一个卫生间。"""
    
    # --------------------------
    # 4. 生成房间布局
    # --------------------------
    
    # 调用房间布局生成函数
    room_layout = generate_room_layout(system_prompt, basic_requirement, api_key)
    
    # 检查生成是否成功
    if room_layout is not None:
        # --------------------------
        # 5. 保存结果
        # --------------------------
        
        # 确保输出目录存在（如果输出路径包含目录）
        output_dir = os.path.dirname(output_file)
        os.makedirs(output_dir, exist_ok=True)
        
        # 将生成的房间布局保存为JSON文件
        with open(output_file, 'w') as f:
            json.dump(room_layout, f, indent=2)  # 格式化输出，便于阅读
        
        # 打印生成结果信息
        print(f"\n----- 生成结果 -----")
        print(f"10x10房间布局矩阵已保存到: {output_file}")
        print(f"矩阵形状: {len(room_layout)}x{len(room_layout[0])}")
        print(f"\n生成的房间布局:")
        # 逐行打印生成的布局矩阵
        for row in room_layout:
            print(row)
        
        # 将生成的布局矩阵输出到Grasshopper的输出端口a
        a = room_layout
    else:
        # 生成失败时的错误提示
        print("\n----- 生成失败 -----")
        print("无法生成房间布局，请检查API密钥或网络连接")

# 程序入口：当直接运行该脚本时，执行main函数
if __name__ == "__main__":
    main()